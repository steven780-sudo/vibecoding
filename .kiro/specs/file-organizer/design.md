# æ–‡ä»¶æ•´ç†åŠ©æ‰‹ - è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æ–‡ä»¶æ•´ç†åŠ©æ‰‹æ˜¯Chronos v2.0çš„ä¸€ä¸ªç‹¬ç«‹åŠŸèƒ½æ¨¡å—ï¼Œé€šè¿‡æ™ºèƒ½ç®—æ³•è¯†åˆ«ç›¸ä¼¼æ–‡ä»¶ï¼Œæä¾›å¯è§†åŒ–çš„äº¤äº’ç•Œé¢ï¼Œå¸®åŠ©ç”¨æˆ·é«˜æ•ˆæ•´ç†å†å²å­˜é‡æ–‡ä»¶ã€‚æœ¬è®¾è®¡æ–‡æ¡£è¯¦ç»†æè¿°äº†ç³»ç»Ÿæ¶æ„ã€ç»„ä»¶è®¾è®¡ã€æ•°æ®æ¨¡å‹ã€ç®—æ³•å®ç°å’Œç”¨æˆ·äº¤äº’æµç¨‹ã€‚

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FileOrganizerâ”‚  â”‚ ScanWizard   â”‚  â”‚ ResultViewer â”‚  â”‚
â”‚  â”‚   Page       â”‚  â”‚  Component   â”‚  â”‚  Component   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ useOrganizer â”‚  â”‚ useSimilarityâ”‚  â”‚ useStaging   â”‚  â”‚
â”‚  â”‚   Hook       â”‚  â”‚    Hook      â”‚  â”‚    Hook      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Organizer    â”‚  â”‚ Similarity   â”‚  â”‚ File         â”‚  â”‚
â”‚  â”‚  Service     â”‚  â”‚  Service     â”‚  â”‚ Service      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Infrastructure Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ File System  â”‚  â”‚ Database     â”‚  â”‚ Logger       â”‚  â”‚
â”‚  â”‚  (Node.js)   â”‚  â”‚  (SQLite)    â”‚  â”‚  Service     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

1. **å‰ç«¯æ¨¡å—** (`src/client/src/`)
   - `pages/FileOrganizerPage.tsx` - ä¸»é¡µé¢
   - `components/organizer/` - ç»„ä»¶ç›®å½•
   - `hooks/useOrganizer.ts` - ä¸šåŠ¡é€»è¾‘Hook
   - `stores/organizer-store.ts` - çŠ¶æ€ç®¡ç†

2. **åç«¯æ¨¡å—** (`src/server/`)
   - `routes/organizer.ts` - APIè·¯ç”±
   - `services/organizer-service.ts` - ä¸šåŠ¡é€»è¾‘
   - `services/similarity-service.ts` - ç›¸ä¼¼åº¦è®¡ç®—
   - `utils/file-scanner.ts` - æ–‡ä»¶æ‰«æå·¥å…·

3. **å…±äº«æ¨¡å—** (`src/shared/`)
   - `types/organizer.ts` - ç±»å‹å®šä¹‰
   - `constants/organizer.ts` - å¸¸é‡å®šä¹‰


## æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ•°æ®ç»“æ„

```typescript
// æ–‡ä»¶ä¿¡æ¯
interface FileInfo {
  id: string;                    // å”¯ä¸€æ ‡è¯†
  path: string;                  // æ–‡ä»¶å®Œæ•´è·¯å¾„
  name: string;                  // æ–‡ä»¶å
  extension: string;             // æ–‡ä»¶æ‰©å±•å
  size: number;                  // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  createdAt: Date;              // åˆ›å»ºæ—¶é—´
  modifiedAt: Date;             // ä¿®æ”¹æ—¶é—´
  type: FileType;               // æ–‡ä»¶ç±»å‹
  status: FileStatus;           // æ–‡ä»¶çŠ¶æ€
}

// æ–‡ä»¶ç±»å‹
enum FileType {
  DOCUMENT = 'document',        // æ–‡æ¡£
  IMAGE = 'image',              // å›¾ç‰‡
  SPREADSHEET = 'spreadsheet',  // è¡¨æ ¼
  ARCHIVE = 'archive',          // å‹ç¼©åŒ…
  OTHER = 'other'               // å…¶ä»–
}

// æ–‡ä»¶çŠ¶æ€
enum FileStatus {
  UNPROCESSED = 'unprocessed',  // æœªå¤„ç†
  STAGED = 'staged',            // å·²æš‚å­˜
  TO_DELETE = 'to_delete',      // å¾…åˆ é™¤
  PROCESSED = 'processed'       // å·²å¤„ç†
}

// æ–‡ä»¶ç»„
interface FileGroup {
  id: string;                   // ç»„ID
  files: FileInfo[];            // æ–‡ä»¶åˆ—è¡¨
  similarity: number;           // ç›¸ä¼¼åº¦ï¼ˆ0-100ï¼‰
  representative: FileInfo;     // ä»£è¡¨æ–‡ä»¶ï¼ˆæœ€æ–°çš„ï¼‰
}

// æ‰«æé…ç½®
interface ScanConfig {
  sourcePath: string;           // æºæ–‡ä»¶å¤¹è·¯å¾„
  includeSubfolders: boolean;   // åŒ…å«å­æ–‡ä»¶å¤¹
  ignoreSystemFiles: boolean;   // å¿½ç•¥ç³»ç»Ÿæ–‡ä»¶
  fileTypesFilter?: string[];   // æ–‡ä»¶ç±»å‹è¿‡æ»¤
}

// ä¿å­˜é…ç½®
interface SaveConfig {
  targetPath: string;           // ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„
  mode: SaveMode;               // ä¿å­˜æ¨¡å¼
  namingRule: NamingRule;       // å‘½åè§„åˆ™
  prefix?: string;              // æ–‡ä»¶åå‰ç¼€
}

// ä¿å­˜æ¨¡å¼
enum SaveMode {
  COPY = 'copy',                // å¤åˆ¶
  MOVE = 'move'                 // ç§»åŠ¨
}

// å‘½åè§„åˆ™
enum NamingRule {
  KEEP_ORIGINAL = 'keep_original',  // ä¿æŒåŸå
  UNIFIED_RENAME = 'unified_rename' // ç»Ÿä¸€é‡å‘½å
}

// æ¸…ç†é…ç½®
interface CleanupConfig {
  mode: CleanupMode;            // æ¸…ç†æ¨¡å¼
  archivePath?: string;         // å½’æ¡£è·¯å¾„
}

// æ¸…ç†æ¨¡å¼
enum CleanupMode {
  PERMANENT_DELETE = 'permanent_delete',  // æ°¸ä¹…åˆ é™¤
  MOVE_TO_TRASH = 'move_to_trash',        // ç§»åŠ¨åˆ°å›æ”¶ç«™
  MOVE_TO_ARCHIVE = 'move_to_archive'     // ç§»åŠ¨åˆ°å½’æ¡£
}

// æ•´ç†ä¼šè¯
interface OrganizerSession {
  id: string;                   // ä¼šè¯ID
  scanConfig: ScanConfig;       // æ‰«æé…ç½®
  scannedFiles: FileInfo[];     // æ‰«æåˆ°çš„æ–‡ä»¶
  fileGroups: FileGroup[];      // æ–‡ä»¶åˆ†ç»„
  stagingArea: FileInfo[];      // æš‚å­˜åŒº
  saveConfig?: SaveConfig;      // ä¿å­˜é…ç½®
  cleanupConfig?: CleanupConfig;// æ¸…ç†é…ç½®
  statistics: Statistics;       // ç»Ÿè®¡ä¿¡æ¯
  createdAt: Date;              // åˆ›å»ºæ—¶é—´
  status: SessionStatus;        // ä¼šè¯çŠ¶æ€
}

// ä¼šè¯çŠ¶æ€
enum SessionStatus {
  SCANNING = 'scanning',        // æ‰«æä¸­
  GROUPING = 'grouping',        // åˆ†ç»„ä¸­
  REVIEWING = 'reviewing',      // å®¡æŸ¥ä¸­
  SAVING = 'saving',            // ä¿å­˜ä¸­
  CLEANING = 'cleaning',        // æ¸…ç†ä¸­
  COMPLETED = 'completed',      // å·²å®Œæˆ
  CANCELLED = 'cancelled'       // å·²å–æ¶ˆ
}

// ç»Ÿè®¡ä¿¡æ¯
interface Statistics {
  totalFiles: number;           // æ€»æ–‡ä»¶æ•°
  totalGroups: number;          // æ€»åˆ†ç»„æ•°
  stagedFiles: number;          // æš‚å­˜æ–‡ä»¶æ•°
  deletedFiles: number;         // åˆ é™¤æ–‡ä»¶æ•°
  savedSpace: number;           // èŠ‚çœç©ºé—´ï¼ˆå­—èŠ‚ï¼‰
}
```


## æ ¸å¿ƒç®—æ³•

### ç›¸ä¼¼åº¦è®¡ç®—ç®—æ³•

```typescript
/**
 * è®¡ç®—ä¸¤ä¸ªæ–‡ä»¶çš„ç›¸ä¼¼åº¦
 * @param file1 ç¬¬ä¸€ä¸ªæ–‡ä»¶
 * @param file2 ç¬¬äºŒä¸ªæ–‡ä»¶
 * @returns ç›¸ä¼¼åº¦åˆ†æ•° (0-100)
 */
function calculateSimilarity(file1: FileInfo, file2: FileInfo): number {
  // 1. æ–‡ä»¶åç›¸ä¼¼åº¦ï¼ˆæƒé‡60%ï¼‰
  const nameSimilarity = calculateNameSimilarity(file1.name, file2.name);
  
  // 2. æ–‡ä»¶å¤§å°æ¥è¿‘åº¦ï¼ˆæƒé‡20%ï¼‰
  const sizeSimilarity = calculateSizeSimilarity(file1.size, file2.size);
  
  // 3. ä¿®æ”¹æ—¶é—´æ¥è¿‘åº¦ï¼ˆæƒé‡20%ï¼‰
  const timeSimilarity = calculateTimeSimilarity(
    file1.modifiedAt,
    file2.modifiedAt
  );
  
  // åŠ æƒå¹³å‡
  return nameSimilarity * 0.6 + sizeSimilarity * 0.2 + timeSimilarity * 0.2;
}

/**
 * è®¡ç®—æ–‡ä»¶åç›¸ä¼¼åº¦ï¼ˆä½¿ç”¨Levenshteinè·ç¦»ï¼‰
 */
function calculateNameSimilarity(name1: string, name2: string): number {
  // ç§»é™¤æ‰©å±•å
  const base1 = removeExtension(name1);
  const base2 = removeExtension(name2);
  
  // æ ‡å‡†åŒ–ï¼ˆè½¬å°å†™ã€ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
  const normalized1 = normalize(base1);
  const normalized2 = normalize(base2);
  
  // è®¡ç®—Levenshteinè·ç¦»
  const distance = levenshteinDistance(normalized1, normalized2);
  const maxLength = Math.max(normalized1.length, normalized2.length);
  
  // è½¬æ¢ä¸ºç›¸ä¼¼åº¦ï¼ˆ0-100ï¼‰
  return ((maxLength - distance) / maxLength) * 100;
}

/**
 * è®¡ç®—æ–‡ä»¶å¤§å°æ¥è¿‘åº¦
 */
function calculateSizeSimilarity(size1: number, size2: number): number {
  if (size1 === 0 || size2 === 0) return 0;
  
  const diff = Math.abs(size1 - size2);
  const max = Math.max(size1, size2);
  
  // å·®å¼‚å°äº10%è®¤ä¸ºç›¸ä¼¼
  return Math.max(0, (1 - diff / max)) * 100;
}

/**
 * è®¡ç®—ä¿®æ”¹æ—¶é—´æ¥è¿‘åº¦
 */
function calculateTimeSimilarity(time1: Date, time2: Date): number {
  const diffMs = Math.abs(time1.getTime() - time2.getTime());
  const diffDays = diffMs / (1000 * 60 * 60 * 24);
  
  // æ—¶é—´å·®è¶Šå°è¶Šç›¸ä¼¼ï¼Œä½¿ç”¨æŒ‡æ•°è¡°å‡
  // 0å¤©=100åˆ†ï¼Œ7å¤©=50åˆ†ï¼Œ30å¤©=10åˆ†
  return Math.max(0, 100 * Math.exp(-diffDays / 10));
}

/**
 * Levenshteinè·ç¦»ç®—æ³•
 */
function levenshteinDistance(str1: string, str2: string): number {
  const m = str1.length;
  const n = str2.length;
  const dp: number[][] = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
  
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;
  
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      if (str1[i - 1] === str2[j - 1]) {
        dp[i][j] = dp[i - 1][j - 1];
      } else {
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,      // åˆ é™¤
          dp[i][j - 1] + 1,      // æ’å…¥
          dp[i - 1][j - 1] + 1   // æ›¿æ¢
        );
      }
    }
  }
  
  return dp[m][n];
}
```

### æ–‡ä»¶åˆ†ç»„ç®—æ³•

```typescript
/**
 * å°†æ–‡ä»¶åˆ—è¡¨åˆ†ç»„
 * @param files æ–‡ä»¶åˆ—è¡¨
 * @param threshold ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤80ï¼‰
 * @returns æ–‡ä»¶åˆ†ç»„åˆ—è¡¨
 */
function groupFiles(files: FileInfo[], threshold: number = 80): FileGroup[] {
  const groups: FileGroup[] = [];
  const processed = new Set<string>();
  
  for (let i = 0; i < files.length; i++) {
    if (processed.has(files[i].id)) continue;
    
    const group: FileInfo[] = [files[i]];
    processed.add(files[i].id);
    
    for (let j = i + 1; j < files.length; j++) {
      if (processed.has(files[j].id)) continue;
      
      const similarity = calculateSimilarity(files[i], files[j]);
      
      if (similarity >= threshold) {
        group.push(files[j]);
        processed.add(files[j].id);
      }
    }
    
    // åªæœ‰åŒ…å«2ä¸ªä»¥ä¸Šæ–‡ä»¶çš„æ‰ç®—ä¸€ç»„
    if (group.length >= 2) {
      // æ‰¾å‡ºæœ€æ–°çš„æ–‡ä»¶ä½œä¸ºä»£è¡¨
      const representative = group.reduce((latest, file) =>
        file.modifiedAt > latest.modifiedAt ? file : latest
      );
      
      // è®¡ç®—ç»„å†…å¹³å‡ç›¸ä¼¼åº¦
      const avgSimilarity = calculateGroupSimilarity(group);
      
      groups.push({
        id: generateId(),
        files: group.sort((a, b) => b.modifiedAt.getTime() - a.modifiedAt.getTime()),
        similarity: avgSimilarity,
        representative
      });
    }
  }
  
  // æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
  return groups.sort((a, b) => b.similarity - a.similarity);
}

/**
 * è®¡ç®—ç»„å†…å¹³å‡ç›¸ä¼¼åº¦
 */
function calculateGroupSimilarity(files: FileInfo[]): number {
  if (files.length < 2) return 100;
  
  let totalSimilarity = 0;
  let count = 0;
  
  for (let i = 0; i < files.length; i++) {
    for (let j = i + 1; j < files.length; j++) {
      totalSimilarity += calculateSimilarity(files[i], files[j]);
      count++;
    }
  }
  
  return totalSimilarity / count;
}
```


## ç»„ä»¶è®¾è®¡

### å‰ç«¯ç»„ä»¶ç»“æ„

```
src/client/src/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ FileOrganizerPage.tsx          # ä¸»é¡µé¢
â”œâ”€â”€ components/organizer/
â”‚   â”œâ”€â”€ ScanWizard.tsx                 # æ‰«æå‘å¯¼
â”‚   â”œâ”€â”€ ScanConfig.tsx                 # æ‰«æé…ç½®
â”‚   â”œâ”€â”€ ScanProgress.tsx               # æ‰«æè¿›åº¦
â”‚   â”œâ”€â”€ FileGroupList.tsx              # æ–‡ä»¶åˆ†ç»„åˆ—è¡¨
â”‚   â”œâ”€â”€ FileGroupItem.tsx              # æ–‡ä»¶åˆ†ç»„é¡¹
â”‚   â”œâ”€â”€ FileItem.tsx                   # æ–‡ä»¶é¡¹
â”‚   â”œâ”€â”€ FilePreview.tsx                # æ–‡ä»¶é¢„è§ˆ
â”‚   â”œâ”€â”€ FileCompare.tsx                # æ–‡ä»¶å¯¹æ¯”
â”‚   â”œâ”€â”€ StagingArea.tsx                # æš‚å­˜åŒº
â”‚   â”œâ”€â”€ SaveConfig.tsx                 # ä¿å­˜é…ç½®
â”‚   â”œâ”€â”€ SaveProgress.tsx               # ä¿å­˜è¿›åº¦
â”‚   â”œâ”€â”€ CleanupConfig.tsx              # æ¸…ç†é…ç½®
â”‚   â”œâ”€â”€ CleanupProgress.tsx            # æ¸…ç†è¿›åº¦
â”‚   â”œâ”€â”€ CompletionSummary.tsx          # å®Œæˆæ‘˜è¦
â”‚   â””â”€â”€ StatisticsPanel.tsx            # ç»Ÿè®¡é¢æ¿
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useOrganizer.ts                # æ•´ç†å™¨Hook
â”‚   â”œâ”€â”€ useSimilarity.ts               # ç›¸ä¼¼åº¦Hook
â”‚   â””â”€â”€ useStaging.ts                  # æš‚å­˜åŒºHook
â””â”€â”€ stores/
    â””â”€â”€ organizer-store.ts             # çŠ¶æ€ç®¡ç†
```

### å…³é”®ç»„ä»¶è®¾è®¡

#### 1. FileOrganizerPageï¼ˆä¸»é¡µé¢ï¼‰

```typescript
/**
 * æ–‡ä»¶æ•´ç†åŠ©æ‰‹ä¸»é¡µé¢
 * è´Ÿè´£æ•´ä½“æµç¨‹æ§åˆ¶å’Œæ­¥éª¤åˆ‡æ¢
 */
export const FileOrganizerPage: React.FC = () => {
  const [currentStep, setCurrentStep] = useState<number>(1);
  const { session, startScan, saveFiles, cleanup } = useOrganizer();
  
  return (
    <div className="file-organizer-page">
      <PageHeader title="æ–‡ä»¶æ•´ç†åŠ©æ‰‹" />
      
      <Steps current={currentStep} className="steps-indicator">
        <Step title="é€‰æ‹©æ–‡ä»¶å¤¹" />
        <Step title="æŸ¥çœ‹åˆ†ç»„" />
        <Step title="ä¿å­˜æ–‡ä»¶" />
        <Step title="æ¸…ç†åŸæ–‡ä»¶" />
      </Steps>
      
      <div className="content">
        {currentStep === 1 && (
          <ScanWizard onComplete={() => setCurrentStep(2)} />
        )}
        {currentStep === 2 && (
          <FileGroupList onNext={() => setCurrentStep(3)} />
        )}
        {currentStep === 3 && (
          <SaveConfig onNext={() => setCurrentStep(4)} />
        )}
        {currentStep === 4 && (
          <CleanupConfig onComplete={() => {}} />
        )}
      </div>
    </div>
  );
};
```

#### 2. FileGroupListï¼ˆæ–‡ä»¶åˆ†ç»„åˆ—è¡¨ï¼‰

```typescript
/**
 * æ–‡ä»¶åˆ†ç»„åˆ—è¡¨ç»„ä»¶
 * æ˜¾ç¤ºç›¸ä¼¼æ–‡ä»¶åˆ†ç»„ï¼Œæ”¯æŒé€‰æ‹©å’Œæš‚å­˜
 */
export const FileGroupList: React.FC<Props> = ({ onNext }) => {
  const { fileGroups, stagingArea } = useOrganizerStore();
  const { addToStaging, removeFromStaging } = useStaging();
  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set());
  
  return (
    <div className="file-group-list">
      <div className="main-content">
        <div className="groups-panel">
          <div className="toolbar">
            <Select value={sortBy} onChange={setSortBy}>
              <Option value="similarity">ç›¸ä¼¼åº¦æ’åº</Option>
              <Option value="size">æ–‡ä»¶å¤§å°</Option>
              <Option value="time">ä¿®æ”¹æ—¶é—´</Option>
            </Select>
            <Input.Search placeholder="æœç´¢æ–‡ä»¶..." />
          </div>
          
          <div className="groups-container">
            {fileGroups.map(group => (
              <FileGroupItem
                key={group.id}
                group={group}
                expanded={expandedGroups.has(group.id)}
                onToggle={() => toggleGroup(group.id)}
                onSelectFile={addToStaging}
              />
            ))}
          </div>
        </div>
        
        <div className="staging-panel">
          <StagingArea
            files={stagingArea}
            onRemove={removeFromStaging}
          />
        </div>
      </div>
      
      <div className="actions">
        <Button onClick={onBack}>ä¸Šä¸€æ­¥</Button>
        <Button type="primary" onClick={onNext}>
          ä¸‹ä¸€æ­¥ï¼šä¿å­˜æ–‡ä»¶
        </Button>
      </div>
    </div>
  );
};
```

#### 3. StagingAreaï¼ˆæš‚å­˜åŒºï¼‰

```typescript
/**
 * æš‚å­˜åŒºç»„ä»¶
 * æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶ï¼Œæ”¯æŒç§»é™¤å’Œæ’åº
 */
export const StagingArea: React.FC<Props> = ({ files, onRemove }) => {
  const totalSize = useMemo(() => 
    files.reduce((sum, file) => sum + file.size, 0),
    [files]
  );
  
  return (
    <div className="staging-area">
      <div className="header">
        <h3>ğŸ“¦ æš‚å­˜åŒº ({files.length}ä¸ªæ–‡ä»¶)</h3>
        <Button size="small" onClick={onClearAll}>
          æ¸…ç©ºæš‚å­˜åŒº
        </Button>
      </div>
      
      <div className="stats">
        <Text type="secondary">
          æ€»å¤§å°: {formatFileSize(totalSize)}
        </Text>
      </div>
      
      <div className="file-list">
        {files.map(file => (
          <div key={file.id} className="staged-file">
            <FileIcon type={file.type} />
            <div className="file-info">
              <div className="file-name">{file.name}</div>
              <div className="file-meta">
                {formatFileSize(file.size)}
              </div>
            </div>
            <Button
              type="text"
              icon={<CloseOutlined />}
              onClick={() => onRemove(file.id)}
            />
          </div>
        ))}
      </div>
    </div>
  );
};
```


## APIè®¾è®¡

### REST APIç«¯ç‚¹

```typescript
// 1. å¼€å§‹æ‰«æ
POST /api/organizer/scan
Request: {
  sourcePath: string;
  includeSubfolders: boolean;
  ignoreSystemFiles: boolean;
  fileTypesFilter?: string[];
}
Response: {
  sessionId: string;
  status: 'scanning';
}

// 2. è·å–æ‰«æè¿›åº¦
GET /api/organizer/scan/:sessionId/progress
Response: {
  status: 'scanning' | 'completed';
  progress: number;  // 0-100
  scannedFiles: number;
  totalFiles: number;
}

// 3. è·å–æ‰«æç»“æœ
GET /api/organizer/scan/:sessionId/result
Response: {
  sessionId: string;
  files: FileInfo[];
  groups: FileGroup[];
  statistics: Statistics;
}

// 4. æ›´æ–°æš‚å­˜åŒº
POST /api/organizer/:sessionId/staging
Request: {
  fileIds: string[];  // è¦æ·»åŠ åˆ°æš‚å­˜åŒºçš„æ–‡ä»¶ID
}
Response: {
  success: boolean;
  stagingArea: FileInfo[];
}

// 5. ä¿å­˜æ–‡ä»¶
POST /api/organizer/:sessionId/save
Request: {
  targetPath: string;
  mode: 'copy' | 'move';
  namingRule: 'keep_original' | 'unified_rename';
  prefix?: string;
}
Response: {
  success: boolean;
  savedFiles: number;
  errors?: Array<{ file: string; error: string }>;
}

// 6. æ¸…ç†æ–‡ä»¶
POST /api/organizer/:sessionId/cleanup
Request: {
  mode: 'permanent_delete' | 'move_to_trash' | 'move_to_archive';
  archivePath?: string;
  fileIds: string[];
}
Response: {
  success: boolean;
  deletedFiles: number;
  savedSpace: number;
}

// 7. è·å–ä¼šè¯ä¿¡æ¯
GET /api/organizer/:sessionId
Response: {
  session: OrganizerSession;
}

// 8. å–æ¶ˆä¼šè¯
DELETE /api/organizer/:sessionId
Response: {
  success: boolean;
}

// 9. æ’¤é”€æ“ä½œ
POST /api/organizer/:sessionId/undo
Response: {
  success: boolean;
  message: string;
}

// 10. åˆ›å»ºæ—¶å…‰åº“
POST /api/organizer/:sessionId/create-repository
Request: {
  path: string;
  message: string;
}
Response: {
  success: boolean;
  repositoryId: string;
}
```

### WebSocketäº‹ä»¶ï¼ˆå®æ—¶è¿›åº¦ï¼‰

```typescript
// å®¢æˆ·ç«¯è®¢é˜…
socket.on('scan:progress', (data: {
  sessionId: string;
  progress: number;
  scannedFiles: number;
  currentFile: string;
}) => {
  // æ›´æ–°UI
});

socket.on('scan:completed', (data: {
  sessionId: string;
  totalFiles: number;
  totalGroups: number;
}) => {
  // æ‰«æå®Œæˆ
});

socket.on('save:progress', (data: {
  sessionId: string;
  progress: number;
  savedFiles: number;
  currentFile: string;
}) => {
  // æ›´æ–°UI
});

socket.on('cleanup:progress', (data: {
  sessionId: string;
  progress: number;
  deletedFiles: number;
}) => {
  // æ›´æ–°UI
});
```


## ç”¨æˆ·äº¤äº’æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```mermaid
graph TD
    A[æ‰“å¼€æ–‡ä»¶æ•´ç†åŠ©æ‰‹] --> B[æ­¥éª¤1: é€‰æ‹©æ‰«æèŒƒå›´]
    B --> C{é…ç½®æ‰«æé€‰é¡¹}
    C --> D[å¼€å§‹æ‰«æ]
    D --> E[æ˜¾ç¤ºæ‰«æè¿›åº¦]
    E --> F[æ­¥éª¤2: æŸ¥çœ‹ç›¸ä¼¼æ–‡ä»¶åˆ†ç»„]
    F --> G{æµè§ˆæ–‡ä»¶ç»„}
    G --> H[é€‰æ‹©è¦ä¿ç•™çš„æ–‡ä»¶]
    H --> I[æ·»åŠ åˆ°æš‚å­˜åŒº]
    I --> J{ç»§ç»­é€‰æ‹©?}
    J -->|æ˜¯| G
    J -->|å¦| K[æ­¥éª¤3: é…ç½®ä¿å­˜é€‰é¡¹]
    K --> L[é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹]
    L --> M[é€‰æ‹©ä¿å­˜æ¨¡å¼]
    M --> N[é…ç½®å‘½åè§„åˆ™]
    N --> O[é¢„è§ˆæ–‡ä»¶å]
    O --> P[å¼€å§‹ä¿å­˜]
    P --> Q[æ˜¾ç¤ºä¿å­˜è¿›åº¦]
    Q --> R[æ­¥éª¤4: æ¸…ç†åŸæ–‡ä»¶]
    R --> S[æŸ¥çœ‹å¾…åˆ é™¤æ–‡ä»¶]
    S --> T[é€‰æ‹©æ¸…ç†æ¨¡å¼]
    T --> U{ç¡®è®¤åˆ é™¤?}
    U -->|æ˜¯| V[æ‰§è¡Œæ¸…ç†]
    U -->|å¦| R
    V --> W[æ˜¾ç¤ºæ¸…ç†è¿›åº¦]
    W --> X[å®Œæˆ: æ˜¾ç¤ºç»Ÿè®¡æŠ¥å‘Š]
    X --> Y{åˆ›å»ºæ—¶å…‰åº“?}
    Y -->|æ˜¯| Z[åˆå§‹åŒ–Chronosä»“åº“]
    Y -->|å¦| AA[å…³é—­]
    Z --> AA
```

### è¯¦ç»†äº¤äº’è¯´æ˜

#### æ­¥éª¤1: é€‰æ‹©æ‰«æèŒƒå›´

**ç•Œé¢å…ƒç´ **:
- æ–‡ä»¶å¤¹é€‰æ‹©å™¨ï¼ˆæ”¯æŒæµè§ˆï¼‰
- æ‰«æé€‰é¡¹å¤é€‰æ¡†
  - â˜‘ï¸ åŒ…å«å­æ–‡ä»¶å¤¹
  - â˜‘ï¸ å¿½ç•¥ç³»ç»Ÿæ–‡ä»¶
  - â˜ ä»…æ‰«ææ–‡æ¡£æ–‡ä»¶
- [å–æ¶ˆ] [å¼€å§‹æ‰«æ] æŒ‰é’®

**äº¤äº’è¡Œä¸º**:
1. ç”¨æˆ·ç‚¹å‡»"æµè§ˆ"æŒ‰é’®ï¼Œæ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
2. ç”¨æˆ·é€‰æ‹©è¦æ‰«æçš„æ–‡ä»¶å¤¹
3. ç”¨æˆ·æ ¹æ®éœ€è¦å‹¾é€‰æ‰«æé€‰é¡¹
4. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ‰«æ"
5. ç³»ç»ŸéªŒè¯è·¯å¾„æœ‰æ•ˆæ€§
6. è¿›å…¥æ‰«æè¿›åº¦ç•Œé¢

**é”™è¯¯å¤„ç†**:
- è·¯å¾„ä¸å­˜åœ¨ â†’ æç¤º"æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©"
- æ— è¯»å–æƒé™ â†’ æç¤º"æ— æƒé™è®¿é—®è¯¥æ–‡ä»¶å¤¹"
- æ–‡ä»¶å¤¹ä¸ºç©º â†’ æç¤º"è¯¥æ–‡ä»¶å¤¹ä¸ºç©º"

#### æ­¥éª¤2: æŸ¥çœ‹ç›¸ä¼¼æ–‡ä»¶åˆ†ç»„

**ç•Œé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ç›¸ä¼¼åº¦æ’åº â–¼] [æœç´¢...]                    æš‚å­˜åŒº(5) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          â”‚                             â”‚
â”‚  ğŸ“‚ ç»„1: é¡¹ç›®æ–‡æ¡£ (3)     â”‚  ğŸ“¦ æš‚å­˜åŒº                  â”‚
â”‚  ç›¸ä¼¼åº¦: 95%             â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â€¢ æ–‡ä»¶1.docx               â”‚
â”‚  â”‚â˜ æ–‡ä»¶1_v1.docx     â”‚ â”‚  â€¢ æ–‡ä»¶2.psd                â”‚
â”‚  â”‚  2.3MB | 09-29     â”‚ â”‚  â€¢ æ–‡ä»¶3.xlsx               â”‚
â”‚  â”‚  [é¢„è§ˆ] [åˆ é™¤]     â”‚ â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  æ€»å¤§å°: 15.6 MB            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                             â”‚
â”‚  â”‚â˜‘ï¸ æ–‡ä»¶1_v2.docx     â”‚ â”‚  [æ¸…ç©ºæš‚å­˜åŒº]               â”‚
â”‚  â”‚  2.5MB | 10-09     â”‚ â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                             â”‚
â”‚                          â”‚                             â”‚
â”‚  [å…¨é€‰] [æ·»åŠ åˆ°æš‚å­˜åŒº]   â”‚                             â”‚
â”‚                          â”‚                             â”‚
â”‚  ğŸ“‚ ç»„2: è®¾è®¡ç¨¿ (5)      â”‚                             â”‚
â”‚  ...                     â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  [ä¸Šä¸€æ­¥]                              [ä¸‹ä¸€æ­¥: ä¿å­˜] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è¡Œä¸º**:
1. ç³»ç»Ÿè‡ªåŠ¨å±•å¼€ç¬¬ä¸€ä¸ªæ–‡ä»¶ç»„
2. ç”¨æˆ·å¯ä»¥ç‚¹å‡»ç»„æ ‡é¢˜å±•å¼€/æŠ˜å 
3. ç”¨æˆ·å‹¾é€‰æ–‡ä»¶å¤é€‰æ¡†
4. ç‚¹å‡»"æ·»åŠ åˆ°æš‚å­˜åŒº"æˆ–ç›´æ¥æ‹–æ‹½åˆ°å³ä¾§
5. æš‚å­˜åŒºå®æ—¶æ›´æ–°æ–‡ä»¶åˆ—è¡¨å’Œç»Ÿè®¡
6. ç”¨æˆ·å¯ä»¥ç‚¹å‡»"é¢„è§ˆ"æŸ¥çœ‹æ–‡ä»¶å†…å®¹
7. ç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå¯¹æ¯”
8. å®Œæˆé€‰æ‹©åç‚¹å‡»"ä¸‹ä¸€æ­¥"

**å¿«æ·æ“ä½œ**:
- åŒå‡»æ–‡ä»¶ â†’ æ·»åŠ åˆ°æš‚å­˜åŒº
- æ‹–æ‹½æ–‡ä»¶ â†’ æ·»åŠ åˆ°æš‚å­˜åŒº
- Ctrl+A â†’ å…¨é€‰å½“å‰ç»„
- Delete â†’ æ ‡è®°ä¸ºåˆ é™¤

#### æ­¥éª¤3: é…ç½®ä¿å­˜é€‰é¡¹

**ç•Œé¢å…ƒç´ **:
- ä¿å­˜æ¨¡å¼å•é€‰æ¡†
  - âšª å¤åˆ¶åˆ°æ–°ä½ç½®ï¼ˆä¿ç•™åŸæ–‡ä»¶ï¼‰
  - âšª ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼ˆåˆ é™¤åŸæ–‡ä»¶ï¼‰
- ç›®æ ‡æ–‡ä»¶å¤¹é€‰æ‹©å™¨
- å‘½åè§„åˆ™å•é€‰æ¡†
  - âšª ä¿æŒåŸæ–‡ä»¶å
  - âšª ç»Ÿä¸€é‡å‘½å: [å‰ç¼€è¾“å…¥æ¡†]
- æ–‡ä»¶åé¢„è§ˆåˆ—è¡¨
- [ä¸Šä¸€æ­¥] [å¼€å§‹ä¿å­˜] æŒ‰é’®

**äº¤äº’è¡Œä¸º**:
1. ç”¨æˆ·é€‰æ‹©ä¿å­˜æ¨¡å¼ï¼ˆé»˜è®¤"å¤åˆ¶"ï¼‰
2. ç”¨æˆ·é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹
3. ç”¨æˆ·é€‰æ‹©å‘½åè§„åˆ™
4. å¦‚æœé€‰æ‹©"ç»Ÿä¸€é‡å‘½å"ï¼Œè¾“å…¥å‰ç¼€
5. ç³»ç»Ÿå®æ—¶æ˜¾ç¤ºæ–‡ä»¶åé¢„è§ˆ
6. ç”¨æˆ·ç¡®è®¤åç‚¹å‡»"å¼€å§‹ä¿å­˜"
7. æ˜¾ç¤ºä¿å­˜è¿›åº¦

**æ–‡ä»¶åå†²çªå¤„ç†**:
- æ£€æµ‹åˆ°åŒåæ–‡ä»¶ â†’ å¼¹å‡ºå¯¹è¯æ¡†
  - [è¦†ç›–] [è·³è¿‡] [é‡å‘½å] [å…¨éƒ¨åº”ç”¨]

#### æ­¥éª¤4: æ¸…ç†åŸæ–‡ä»¶

**ç•Œé¢å…ƒç´ **:
- å¾…åˆ é™¤æ–‡ä»¶åˆ—è¡¨ï¼ˆå¸¦å¤é€‰æ¡†ï¼‰
- æ¸…ç†æ¨¡å¼å•é€‰æ¡†
  - âšª æ°¸ä¹…åˆ é™¤
  - âšª ç§»åŠ¨åˆ°å›æ”¶ç«™ï¼ˆæ¨èï¼‰
  - âšª ç§»åŠ¨åˆ°å½’æ¡£æ–‡ä»¶å¤¹
- å½’æ¡£ä½ç½®é€‰æ‹©å™¨ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰
- âš ï¸ è­¦å‘Šæç¤º
- [è·³è¿‡] [å–æ¶ˆ] [ç¡®è®¤åˆ é™¤] æŒ‰é’®

**äº¤äº’è¡Œä¸º**:
1. ç³»ç»Ÿåˆ—å‡ºæ‰€æœ‰æœªæ·»åŠ åˆ°æš‚å­˜åŒºçš„æ–‡ä»¶
2. é»˜è®¤å…¨é€‰æ‰€æœ‰æ–‡ä»¶
3. ç”¨æˆ·å¯ä»¥å–æ¶ˆå‹¾é€‰ä¸æƒ³åˆ é™¤çš„æ–‡ä»¶
4. ç”¨æˆ·é€‰æ‹©æ¸…ç†æ¨¡å¼ï¼ˆé»˜è®¤"å›æ”¶ç«™"ï¼‰
5. å¦‚æœé€‰æ‹©"å½’æ¡£"ï¼Œé€‰æ‹©å½’æ¡£ä½ç½®
6. ç‚¹å‡»"ç¡®è®¤åˆ é™¤"
7. æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
8. ç¡®è®¤åæ‰§è¡Œæ¸…ç†
9. æ˜¾ç¤ºæ¸…ç†è¿›åº¦

**å®‰å…¨æœºåˆ¶**:
- æ°¸ä¹…åˆ é™¤ â†’ çº¢è‰²è­¦å‘Š + äºŒæ¬¡ç¡®è®¤
- å›æ”¶ç«™ â†’ é»„è‰²æç¤º
- å½’æ¡£ â†’ ç»¿è‰²æç¤º

#### å®Œæˆ: ç»Ÿè®¡æŠ¥å‘Š

**ç•Œé¢å…ƒç´ **:
- âœ… å®Œæˆå›¾æ ‡
- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
  - æ‰«ææ–‡ä»¶: 1,234ä¸ª
  - ç›¸ä¼¼æ–‡ä»¶ç»„: 23ç»„
  - ä¿å­˜æ–‡ä»¶: 5ä¸ª
  - åˆ é™¤æ–‡ä»¶: 18ä¸ª
  - èŠ‚çœç©ºé—´: 45.6 MB
- ğŸ’¡ å»ºè®®æç¤º
- [å…³é—­] [åˆ›å»ºæ—¶å…‰åº“] æŒ‰é’®

**äº¤äº’è¡Œä¸º**:
1. æ˜¾ç¤ºæ•´ç†ç»Ÿè®¡
2. å¦‚æœç”¨æˆ·ç‚¹å‡»"åˆ›å»ºæ—¶å…‰åº“"
   - è‡ªåŠ¨ä¸ºç›®æ ‡æ–‡ä»¶å¤¹åˆå§‹åŒ–Chronosä»“åº“
   - åˆ›å»ºåˆå§‹å¿«ç…§
   - è·³è½¬åˆ°ä»“åº“ç®¡ç†é¡µé¢
3. å¦‚æœç‚¹å‡»"å…³é—­"
   - è¿”å›ä¸»é¡µé¢


## çŠ¶æ€ç®¡ç†

### Zustand Storeè®¾è®¡

```typescript
interface OrganizerStore {
  // çŠ¶æ€
  session: OrganizerSession | null;
  currentStep: number;
  loading: boolean;
  error: string | null;
  
  // æ‰«æç›¸å…³
  scanConfig: ScanConfig | null;
  scanProgress: number;
  scannedFiles: FileInfo[];
  fileGroups: FileGroup[];
  
  // æš‚å­˜åŒº
  stagingArea: FileInfo[];
  
  // ä¿å­˜é…ç½®
  saveConfig: SaveConfig | null;
  saveProgress: number;
  
  // æ¸…ç†é…ç½®
  cleanupConfig: CleanupConfig | null;
  cleanupProgress: number;
  
  // ç»Ÿè®¡
  statistics: Statistics;
  
  // Actions
  startScan: (config: ScanConfig) => Promise<void>;
  updateScanProgress: (progress: number) => void;
  setScanResult: (files: FileInfo[], groups: FileGroup[]) => void;
  
  addToStaging: (fileId: string) => void;
  removeFromStaging: (fileId: string) => void;
  clearStaging: () => void;
  
  setSaveConfig: (config: SaveConfig) => void;
  saveFiles: () => Promise<void>;
  updateSaveProgress: (progress: number) => void;
  
  setCleanupConfig: (config: CleanupConfig) => void;
  cleanup: () => Promise<void>;
  updateCleanupProgress: (progress: number) => void;
  
  setCurrentStep: (step: number) => void;
  reset: () => void;
}

// Storeå®ç°
export const useOrganizerStore = create<OrganizerStore>((set, get) => ({
  // åˆå§‹çŠ¶æ€
  session: null,
  currentStep: 1,
  loading: false,
  error: null,
  scanConfig: null,
  scanProgress: 0,
  scannedFiles: [],
  fileGroups: [],
  stagingArea: [],
  saveConfig: null,
  saveProgress: 0,
  cleanupConfig: null,
  cleanupProgress: 0,
  statistics: {
    totalFiles: 0,
    totalGroups: 0,
    stagedFiles: 0,
    deletedFiles: 0,
    savedSpace: 0
  },
  
  // Actionså®ç°
  startScan: async (config) => {
    set({ loading: true, scanConfig: config });
    try {
      const response = await api.post('/organizer/scan', config);
      set({ session: response.data });
    } catch (error) {
      set({ error: error.message });
    } finally {
      set({ loading: false });
    }
  },
  
  addToStaging: (fileId) => {
    const { scannedFiles, stagingArea } = get();
    const file = scannedFiles.find(f => f.id === fileId);
    if (file && !stagingArea.find(f => f.id === fileId)) {
      set({
        stagingArea: [...stagingArea, { ...file, status: FileStatus.STAGED }],
        statistics: {
          ...get().statistics,
          stagedFiles: stagingArea.length + 1
        }
      });
    }
  },
  
  // ... å…¶ä»–actions
}));
```

## é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹å®šä¹‰

```typescript
enum OrganizerErrorCode {
  // æ‰«æé”™è¯¯
  SCAN_PATH_NOT_FOUND = 'SCAN_PATH_NOT_FOUND',
  SCAN_PERMISSION_DENIED = 'SCAN_PERMISSION_DENIED',
  SCAN_EMPTY_FOLDER = 'SCAN_EMPTY_FOLDER',
  
  // ä¿å­˜é”™è¯¯
  SAVE_PATH_NOT_FOUND = 'SAVE_PATH_NOT_FOUND',
  SAVE_PERMISSION_DENIED = 'SAVE_PERMISSION_DENIED',
  SAVE_DISK_FULL = 'SAVE_DISK_FULL',
  SAVE_FILE_EXISTS = 'SAVE_FILE_EXISTS',
  
  // æ¸…ç†é”™è¯¯
  CLEANUP_PERMISSION_DENIED = 'CLEANUP_PERMISSION_DENIED',
  CLEANUP_FILE_IN_USE = 'CLEANUP_FILE_IN_USE',
  
  // ç³»ç»Ÿé”™è¯¯
  NETWORK_ERROR = 'NETWORK_ERROR',
  UNKNOWN_ERROR = 'UNKNOWN_ERROR'
}

interface OrganizerError {
  code: OrganizerErrorCode;
  message: string;
  details?: any;
}
```

### é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
function handleOrganizerError(error: OrganizerError): void {
  logger.error('Organizer error:', error);
  
  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
  switch (error.code) {
    case OrganizerErrorCode.SCAN_PATH_NOT_FOUND:
      message.error('æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©');
      break;
      
    case OrganizerErrorCode.SCAN_PERMISSION_DENIED:
      message.error('æ— æƒé™è®¿é—®è¯¥æ–‡ä»¶å¤¹ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
      break;
      
    case OrganizerErrorCode.SAVE_DISK_FULL:
      message.error('ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†åé‡è¯•');
      break;
      
    case OrganizerErrorCode.SAVE_FILE_EXISTS:
      // æ˜¾ç¤ºæ–‡ä»¶å†²çªå¯¹è¯æ¡†
      showFileConflictDialog(error.details);
      break;
      
    default:
      message.error('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// é‡è¯•æœºåˆ¶
async function withRetry<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  let lastError: Error;
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      if (i < maxRetries - 1) {
        await sleep(1000 * (i + 1)); // æŒ‡æ•°é€€é¿
      }
    }
  }
  
  throw lastError;
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ–‡ä»¶æ‰«æä¼˜åŒ–

```typescript
// ä½¿ç”¨Workerè¿›è¡Œå¹¶è¡Œæ‰«æ
class FileScanner {
  private workers: Worker[] = [];
  private readonly WORKER_COUNT = 4;
  
  async scan(path: string, config: ScanConfig): Promise<FileInfo[]> {
    // åˆå§‹åŒ–Workers
    this.initWorkers();
    
    // è·å–é¡¶å±‚æ–‡ä»¶åˆ—è¡¨
    const entries = await fs.readdir(path, { withFileTypes: true });
    
    // åˆ†é…ä»»åŠ¡åˆ°Workers
    const chunks = this.chunkArray(entries, this.WORKER_COUNT);
    const promises = chunks.map((chunk, index) =>
      this.scanChunk(chunk, this.workers[index])
    );
    
    // ç­‰å¾…æ‰€æœ‰Workerå®Œæˆ
    const results = await Promise.all(promises);
    
    // åˆå¹¶ç»“æœ
    return results.flat();
  }
  
  private async scanChunk(
    entries: Dirent[],
    worker: Worker
  ): Promise<FileInfo[]> {
    return new Promise((resolve) => {
      worker.postMessage({ entries });
      worker.onmessage = (e) => resolve(e.data);
    });
  }
}
```

### 2. ç›¸ä¼¼åº¦è®¡ç®—ä¼˜åŒ–

```typescript
// ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—
class SimilarityCache {
  private cache = new Map<string, number>();
  
  get(file1Id: string, file2Id: string): number | undefined {
    const key = this.getKey(file1Id, file2Id);
    return this.cache.get(key);
  }
  
  set(file1Id: string, file2Id: string, similarity: number): void {
    const key = this.getKey(file1Id, file2Id);
    this.cache.set(key, similarity);
  }
  
  private getKey(id1: string, id2: string): string {
    return id1 < id2 ? `${id1}:${id2}` : `${id2}:${id1}`;
  }
}

// æ‰¹é‡è®¡ç®—ç›¸ä¼¼åº¦
async function calculateSimilarityBatch(
  files: FileInfo[],
  batchSize: number = 100
): Promise<Map<string, number>> {
  const cache = new SimilarityCache();
  const results = new Map<string, number>();
  
  for (let i = 0; i < files.length; i += batchSize) {
    const batch = files.slice(i, i + batchSize);
    
    // å¹¶è¡Œè®¡ç®—æ‰¹æ¬¡å†…çš„ç›¸ä¼¼åº¦
    await Promise.all(
      batch.map(async (file1, idx1) => {
        for (let idx2 = idx1 + 1; idx2 < batch.length; idx2++) {
          const file2 = batch[idx2];
          const similarity = calculateSimilarity(file1, file2);
          cache.set(file1.id, file2.id, similarity);
          results.set(`${file1.id}:${file2.id}`, similarity);
        }
      })
    );
  }
  
  return results;
}
```

### 3. è™šæ‹Ÿæ»šåŠ¨

```typescript
// ä½¿ç”¨react-windowå®ç°è™šæ‹Ÿæ»šåŠ¨
import { FixedSizeList } from 'react-window';

export const FileGroupList: React.FC = () => {
  const { fileGroups } = useOrganizerStore();
  
  const Row = ({ index, style }) => (
    <div style={style}>
      <FileGroupItem group={fileGroups[index]} />
    </div>
  );
  
  return (
    <FixedSizeList
      height={600}
      itemCount={fileGroups.length}
      itemSize={120}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
};
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```typescript
describe('SimilarityService', () => {
  describe('calculateSimilarity', () => {
    it('should return 100 for identical files', () => {
      const file1 = createMockFile('test.txt');
      const file2 = createMockFile('test.txt');
      expect(calculateSimilarity(file1, file2)).toBe(100);
    });
    
    it('should return high similarity for similar names', () => {
      const file1 = createMockFile('project_v1.docx');
      const file2 = createMockFile('project_v2.docx');
      const similarity = calculateSimilarity(file1, file2);
      expect(similarity).toBeGreaterThan(80);
    });
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
describe('Organizer API', () => {
  it('should scan folder and return file groups', async () => {
    const response = await request(app)
      .post('/api/organizer/scan')
      .send({
        sourcePath: '/test/folder',
        includeSubfolders: true
      });
    
    expect(response.status).toBe(200);
    expect(response.body.sessionId).toBeDefined();
  });
});
```

### E2Eæµ‹è¯•

```typescript
describe('File Organizer Flow', () => {
  it('should complete full organization flow', async () => {
    // 1. æ‰“å¼€æ–‡ä»¶æ•´ç†åŠ©æ‰‹
    await page.goto('/organizer');
    
    // 2. é€‰æ‹©æ–‡ä»¶å¤¹
    await page.click('[data-testid="browse-button"]');
    // ... é€‰æ‹©æ–‡ä»¶å¤¹
    
    // 3. å¼€å§‹æ‰«æ
    await page.click('[data-testid="start-scan"]');
    await page.waitForSelector('[data-testid="scan-completed"]');
    
    // 4. é€‰æ‹©æ–‡ä»¶
    await page.click('[data-testid="file-checkbox-1"]');
    await page.click('[data-testid="add-to-staging"]');
    
    // 5. ä¿å­˜æ–‡ä»¶
    await page.click('[data-testid="next-step"]');
    // ... é…ç½®ä¿å­˜é€‰é¡¹
    
    // 6. éªŒè¯ç»“æœ
    const summary = await page.textContent('[data-testid="summary"]');
    expect(summary).toContain('æ•´ç†å®Œæˆ');
  });
});
```

## å®‰å…¨è€ƒè™‘

### 1. è·¯å¾„éªŒè¯

```typescript
function validatePath(path: string): boolean {
  // é˜²æ­¢è·¯å¾„éå†æ”»å‡»
  const normalized = path.normalize(path);
  if (normalized.includes('..')) {
    throw new Error('Invalid path: path traversal detected');
  }
  
  // æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…è®¸çš„èŒƒå›´å†…
  const allowedPaths = ['/Users', '/home'];
  if (!allowedPaths.some(allowed => normalized.startsWith(allowed))) {
    throw new Error('Invalid path: outside allowed directories');
  }
  
  return true;
}
```

### 2. æ–‡ä»¶æ“ä½œæƒé™æ£€æŸ¥

```typescript
async function checkPermissions(path: string): Promise<void> {
  try {
    await fs.access(path, fs.constants.R_OK | fs.constants.W_OK);
  } catch (error) {
    throw new OrganizerError({
      code: OrganizerErrorCode.SCAN_PERMISSION_DENIED,
      message: 'No permission to access this path'
    });
  }
}
```

### 3. æ–‡ä»¶å¤§å°é™åˆ¶

```typescript
const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB
const MAX_TOTAL_SIZE = 10 * 1024 * 1024 * 1024; // 10GB

function validateFileSize(files: FileInfo[]): void {
  const totalSize = files.reduce((sum, file) => sum + file.size, 0);
  
  if (totalSize > MAX_TOTAL_SIZE) {
    throw new Error('Total file size exceeds limit');
  }
  
  const oversizedFiles = files.filter(f => f.size > MAX_FILE_SIZE);
  if (oversizedFiles.length > 0) {
    throw new Error('Some files exceed size limit');
  }
}
```

## éƒ¨ç½²è€ƒè™‘

### æ•°æ®åº“Schema

```sql
-- æ•´ç†ä¼šè¯è¡¨
CREATE TABLE organizer_sessions (
  id TEXT PRIMARY KEY,
  scan_config TEXT NOT NULL,
  status TEXT NOT NULL,
  statistics TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ–‡ä»¶è®°å½•è¡¨
CREATE TABLE organizer_files (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  path TEXT NOT NULL,
  name TEXT NOT NULL,
  size INTEGER NOT NULL,
  status TEXT NOT NULL,
  created_at DATETIME,
  modified_at DATETIME,
  FOREIGN KEY (session_id) REFERENCES organizer_sessions(id)
);

-- æ–‡ä»¶ç»„è¡¨
CREATE TABLE organizer_groups (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  similarity REAL NOT NULL,
  representative_file_id TEXT NOT NULL,
  FOREIGN KEY (session_id) REFERENCES organizer_sessions(id)
);

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE organizer_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  action TEXT NOT NULL,
  details TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (session_id) REFERENCES organizer_sessions(id)
);
```

### é…ç½®é¡¹

```typescript
// config/organizer.ts
export const organizerConfig = {
  // æ‰«æé…ç½®
  scan: {
    maxFiles: 10000,              // æœ€å¤§æ–‡ä»¶æ•°
    maxDepth: 10,                 // æœ€å¤§ç›®å½•æ·±åº¦
    timeout: 300000,              // æ‰«æè¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
    workerCount: 4,               // Workeræ•°é‡
  },
  
  // ç›¸ä¼¼åº¦é…ç½®
  similarity: {
    threshold: 80,                // ç›¸ä¼¼åº¦é˜ˆå€¼
    nameWeight: 0.6,              // æ–‡ä»¶åæƒé‡
    sizeWeight: 0.2,              // å¤§å°æƒé‡
    timeWeight: 0.2,              // æ—¶é—´æƒé‡
  },
  
  // æ€§èƒ½é…ç½®
  performance: {
    batchSize: 100,               // æ‰¹å¤„ç†å¤§å°
    cacheSize: 1000,              // ç¼“å­˜å¤§å°
    enableVirtualScroll: true,    // å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
  },
  
  // å®‰å…¨é…ç½®
  security: {
    maxFileSize: 1024 * 1024 * 1024,      // 1GB
    maxTotalSize: 10 * 1024 * 1024 * 1024, // 10GB
    allowedPaths: ['/Users', '/home'],     // å…è®¸çš„è·¯å¾„
  }
};
```

## æœªæ¥æ‰©å±•

### 1. AIè¾…åŠ©åˆ†ç±»

```typescript
// ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œæ–‡ä»¶åˆ†ç±»
interface AIClassifier {
  classify(file: FileInfo): Promise<string>;
  suggestName(file: FileInfo): Promise<string>;
}
```

### 2. äº‘ç«¯åŒæ­¥

```typescript
// æ”¯æŒäº‘ç«¯æ–‡ä»¶æ‰«æå’Œæ•´ç†
interface CloudOrganizer {
  scanCloudFolder(path: string): Promise<FileInfo[]>;
  syncToCloud(files: FileInfo[]): Promise<void>;
}
```

### 3. æ‰¹é‡æ ¼å¼è½¬æ¢

```typescript
// æ•´ç†æ—¶è‡ªåŠ¨è½¬æ¢æ–‡ä»¶æ ¼å¼
interface FileConverter {
  convert(file: FileInfo, targetFormat: string): Promise<FileInfo>;
}
```
