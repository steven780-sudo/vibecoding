# 需求文档 - 文件树状展示功能

## 简介

当前Chronos应用在显示"待提交的变更"时存在以下问题：

1. **Git行为问题**：当文件夹下所有文件都是未追踪状态时，`git status --porcelain`只返回文件夹路径（如 `one/`），而不返回具体文件路径
2. **展示问题**：即使Git返回完整文件路径，前端也只是简单地列表展示，没有树状结构

**问题根源**：
- Git对于未追踪的文件夹，默认只显示文件夹名称，不展开显示内部文件
- 需要使用 `git status --porcelain -uall` 参数来显示所有未追踪的文件

本需求旨在：
1. 修复后端Git命令，使用正确的参数获取所有文件
2. 改进前端展示方式，将扁平的文件路径列表转换为树状结构
3. 让用户能够清晰地看到完整的文件夹层级和具体文件，并支持选择性提交

## 术语表

- **System**: Chronos文件时光机应用
- **FileTree**: 文件树状结构组件
- **FileChange**: 文件变更记录（包含状态和路径）
- **TreeNode**: 树节点（可以是文件夹或文件）
- **StatusIndicator**: 状态指示器（新增🟢、修改🟡、删除🔴）

## 需求

### 需求 1：修复Git命令获取所有文件

**用户故事**：作为用户，我希望能看到文件夹内的所有文件变更，而不仅仅是文件夹名称，这样我就能准确了解哪些文件发生了变更。

#### 验收标准

1. WHEN System执行git status命令，THE System SHALL 使用`--porcelain -uall`参数来获取所有未追踪文件的完整路径
2. WHEN 文件夹下有多个未追踪文件，THE System SHALL 返回每个文件的完整路径（如 `one/文字文稿1.docx`），而不是只返回文件夹路径（如 `one/`）
3. WHEN 文件夹下有已修改或已删除的文件，THE System SHALL 正确返回这些文件的完整路径
4. THE System SHALL 保持对系统文件的过滤功能（如.DS_Store）
5. THE System SHALL 保持对Git管理文件的过滤功能（如.gitignore、.chronos）

### 需求 2：文件树状展示

**用户故事**：作为用户，我希望在"待提交的变更"区域看到完整的文件夹树状结构，这样我就能清楚地了解哪些文件发生了变更。

#### 验收标准

1. WHEN 用户打开已初始化的项目文件夹，THE System SHALL 将文件变更列表转换为树状结构展示
2. WHEN 文件路径包含多级目录（如 `one/three/文字文稿3.docx`），THE System SHALL 展示完整的目录层级结构
3. WHEN 同一文件夹下有多个文件变更，THE System SHALL 将这些文件归类在同一个文件夹节点下
4. WHEN 文件夹节点被点击，THE System SHALL 展开或折叠该文件夹的子节点
5. THE System SHALL 为每个文件显示状态指示器（🟢新增、🟡修改、🔴删除）

### 需求 2：树节点交互

**用户故事**：作为用户，我希望能够展开/折叠文件夹节点，这样我就能更好地浏览大量文件变更。

#### 验收标准

1. WHEN 用户点击文件夹节点，THE System SHALL 切换该节点的展开/折叠状态
2. WHEN 文件夹节点展开，THE System SHALL 显示该文件夹下的所有子节点（文件和子文件夹）
3. WHEN 文件夹节点折叠，THE System SHALL 隐藏该文件夹下的所有子节点
4. THE System SHALL 默认展开所有文件夹节点
5. THE System SHALL 为文件夹节点显示展开/折叠图标（▶️/▼）

### 需求 3：文件选择功能

**用户故事**：作为用户，我希望能够在树状结构中选择要提交的文件，这样我就能灵活地控制每次提交的内容。

#### 验收标准

1. WHEN 用户在创建快照对话框中查看文件树，THE System SHALL 为每个文件节点显示复选框
2. WHEN 用户点击文件节点的复选框，THE System SHALL 切换该文件的选中状态
3. WHEN 用户点击文件夹节点的复选框，THE System SHALL 同时选中或取消选中该文件夹下的所有文件
4. WHEN 文件夹下的所有文件都被选中，THE System SHALL 自动选中该文件夹的复选框
5. WHEN 文件夹下部分文件被选中，THE System SHALL 显示文件夹复选框为半选状态

### 需求 4：视觉优化

**用户故事**：作为用户，我希望文件树的视觉呈现清晰美观，这样我就能快速识别文件和文件夹。

#### 验收标准

1. THE System SHALL 为文件夹节点显示文件夹图标（📁）
2. THE System SHALL 为文件节点显示文件图标（📄）
3. THE System SHALL 使用缩进来表示文件夹层级关系
4. THE System SHALL 为不同状态的文件使用不同的颜色标识
5. THE System SHALL 在文件树容器中提供滚动功能，当内容超出可视区域时

### 需求 5：性能优化

**用户故事**：作为用户，我希望即使有大量文件变更时，文件树也能快速渲染和响应，这样我就能流畅地使用应用。

#### 验收标准

1. WHEN 文件变更数量超过100个，THE System SHALL 在500毫秒内完成树状结构的构建和渲染
2. WHEN 用户展开或折叠节点，THE System SHALL 在100毫秒内完成UI更新
3. THE System SHALL 使用虚拟滚动技术，当文件数量超过1000个时
4. THE System SHALL 缓存已构建的树状结构，避免重复计算
5. THE System SHALL 使用React.memo优化组件渲染性能
